<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>WealthGrows - 这日子还过吗</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
      @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Playfair+Display:ital,wght@0,400;0,600;0,700;1,400&display=swap');
      
      body {
        font-family: 'Inter', sans-serif;
        background-color: #F2F0E9;
        color: #1C1917;
      }
      
      .font-serif {
        font-family: 'Playfair Display', serif;
      }

      .no-scrollbar::-webkit-scrollbar {
        display: none;
      }
      .no-scrollbar {
        -ms-overflow-style: none;
        scrollbar-width: none;
      }

      @keyframes shake {
        0% { transform: rotate(0deg); }
        25% { transform: rotate(2deg); }
        50% { transform: rotate(0deg); }
        75% { transform: rotate(-2deg); }
        100% { transform: rotate(0deg); }
      }
      
      .animate-shake {
        animation: shake 0.2s ease-in-out infinite;
      }
      
      /* Markdown basic styles for report */
      .markdown-body h1, .markdown-body h2, .markdown-body h3 { font-family: 'Playfair Display', serif; margin-top: 1em; margin-bottom: 0.5em; font-weight: bold; }
      .markdown-body ul { list-style-type: disc; padding-left: 1.5em; margin-bottom: 1em; }
      .markdown-body li { margin-bottom: 0.5em; }
      .markdown-body p { margin-bottom: 1em; }
      .markdown-body strong { font-weight: 700; color: #1C1917; }
    </style>
    <script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@18.2.0",
    "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
    "lucide-react": "https://esm.sh/lucide-react@0.292.0",
    "recharts": "https://esm.sh/recharts@2.12.0",
    "@google/genai": "https://esm.sh/@google/genai@0.1.1",
    "react/": "https://esm.sh/react@^19.2.3/",
    "react-dom/": "https://esm.sh/react-dom@^19.2.3/"
  }
}
</script>
</head>
<body>
    <div id="root"></div>
    
    <!-- Shim for process.env -->
    <script>
        window.process = { env: { API_KEY: '' } }; // 用户需在此处填入 API Key
    </script>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef, useMemo } from 'react';
        import { createRoot } from 'react-dom/client';
        import * as Lucide from 'lucide-react';
        import { ResponsiveContainer, PieChart as RechartsPie, Pie, Cell, Tooltip } from 'recharts';
        import { GoogleGenAI } from '@google/genai';

        const { 
            Plus, Wallet, PieChart, Sparkles, TrendingUp, AlertCircle, ArrowUpRight, ArrowDownRight, 
            ChevronDown, CalendarDays, FileText, Calendar, ArrowUp, ArrowDown, Palette, Check, X, 
            Trash2, MinusCircle, Edit3, ArrowLeft, Delete,
            Utensils, Bus, ShoppingBag, Gamepad2, Stethoscope, GraduationCap, Home, Briefcase, 
            HeartHandshake, Banknote, Car, Plane, Gift, Smartphone, Coffee, Dumbbell, PawPrint, Music,
            Zap, Droplet, Wifi, ShoppingCart, Film, Book, Wrench, Hammer, Baby, Beer, 
            Scissors, Shirt, Watch, Smile, Star, Heart, Sun, Moon, Cloud, Umbrella, Key,
            Laptop, Camera, Bike, Bed, Sofa, Bath
        } = Lucide;

        // --- TYPES & CONSTANTS ---
        const TransactionType = { EXPENSE: 'EXPENSE', INCOME: 'INCOME', TRANSFER: 'TRANSFER' };
        const MacroCategory = {
            SURVIVAL: '固定生存成本', DAILY_FOOD: '吃喝日常', ENJOYMENT: '享受型消费',
            NECESSARY: '必要支出', INVESTMENT: '投资理财', INCOME: '收入', TRANSFER: '转账'
        };

        const AVAILABLE_ICONS = [
            'Utensils', 'Coffee', 'Beer', 'ShoppingBag', 'ShoppingCart', 'Shirt', 'Watch', 'Gift', 
            'Bus', 'Car', 'Plane', 'Bike', 'Home', 'Bed', 'Sofa', 'Bath', 'Zap', 'Droplet', 'Wifi',
            'Gamepad2', 'Film', 'Music', 'Camera', 'Dumbbell', 'PawPrint', 'Baby', 'Smile', 'Heart',
            'Stethoscope', 'GraduationCap', 'Book', 'Briefcase', 'Laptop', 'Smartphone', 'Wrench', 'Hammer',
            'TrendingUp', 'Banknote', 'Wallet', 'Key', 'Sun', 'Moon', 'Star', 'Cloud', 'Umbrella'
        ];

        const DEFAULT_CATEGORIES = [
            { id: 'food', name: '餐饮', icon: 'Utensils', type: TransactionType.EXPENSE, macroCategory: MacroCategory.DAILY_FOOD },
            { id: 'transport', name: '交通', icon: 'Bus', type: TransactionType.EXPENSE, macroCategory: MacroCategory.NECESSARY },
            { id: 'shopping', name: '购物', icon: 'ShoppingBag', type: TransactionType.EXPENSE, macroCategory: MacroCategory.ENJOYMENT },
            { id: 'entertainment', name: '娱乐', icon: 'Gamepad2', type: TransactionType.EXPENSE, macroCategory: MacroCategory.ENJOYMENT },
            { id: 'medical', name: '医疗', icon: 'Stethoscope', type: TransactionType.EXPENSE, macroCategory: MacroCategory.SURVIVAL },
            { id: 'learning', name: '学习', icon: 'GraduationCap', type: TransactionType.EXPENSE, macroCategory: MacroCategory.INVESTMENT },
            { id: 'rent', name: '房租', icon: 'Home', type: TransactionType.EXPENSE, macroCategory: MacroCategory.SURVIVAL },
            { id: 'invest_product', name: '理财', icon: 'TrendingUp', type: TransactionType.EXPENSE, macroCategory: MacroCategory.INVESTMENT },
            { id: 'salary', name: '工资', icon: 'Briefcase', type: TransactionType.INCOME, macroCategory: MacroCategory.INCOME },
            { id: 'bonus', name: '奖金', icon: 'Banknote', type: TransactionType.INCOME, macroCategory: MacroCategory.INCOME },
            { id: 'invest_return', name: '投资回报', icon: 'TrendingUp', type: TransactionType.INCOME, macroCategory: MacroCategory.INCOME },
            { id: 'part_time', name: '兼职', icon: 'Wallet', type: TransactionType.INCOME, macroCategory: MacroCategory.INCOME },
            { id: 'transfer', name: '转账', icon: 'HeartHandshake', type: TransactionType.TRANSFER, macroCategory: MacroCategory.TRANSFER },
        ];

        const getIconComponent = (iconName, size = 20, color) => {
             const props = { size, color };
             const Icon = Lucide[iconName] || Lucide.Wallet;
             return <Icon {...props} />;
        };

        const MACRO_COLORS = {
            [MacroCategory.SURVIVAL]: '#6B705C',
            [MacroCategory.DAILY_FOOD]: '#D4A373',
            [MacroCategory.ENJOYMENT]: '#BC4749',
            [MacroCategory.NECESSARY]: '#457B9D',
            [MacroCategory.INVESTMENT]: '#2A9D8F',
            [MacroCategory.INCOME]: '#6D597A',
            [MacroCategory.TRANSFER]: '#A5A58D',
        };

        const CATEGORY_ICON_COLORS = [
            '#E76F51', '#264653', '#E9C46A', '#F4A261', '#83C5BE', '#006D77',
            '#FFB4A2', '#B5838D', '#6D6875', '#5F0F40', '#9A031E', '#FB8B24'
        ];

        const hexToRgba = (hex, alpha) => {
            let r = 0, g = 0, b = 0;
            if (hex.length === 4) {
                r = parseInt(hex[1] + hex[1], 16); g = parseInt(hex[2] + hex[2], 16); b = parseInt(hex[3] + hex[3], 16);
            } else if (hex.length === 7) {
                r = parseInt(hex.slice(1, 3), 16); g = parseInt(hex.slice(3, 5), 16); b = parseInt(hex.slice(5, 7), 16);
            }
            return `rgba(${r}, ${g}, ${b}, ${alpha})`;
        };

        const getCategoryColor = (id) => {
            let hash = 0;
            for (let i = 0; i < id.length; i++) hash = id.charCodeAt(i) + ((hash << 5) - hash);
            return CATEGORY_ICON_COLORS[Math.abs(hash) % CATEGORY_ICON_COLORS.length];
        };

        // --- SERVICES ---
        const STORAGE_KEY_TX = 'wealthgrows_transactions';
        const STORAGE_KEY_CATS = 'wealthgrows_categories';

        const getTransactions = () => {
            const stored = localStorage.getItem(STORAGE_KEY_TX);
            return stored ? JSON.parse(stored) : [];
        };
        const saveTransaction = (transaction) => {
            const current = getTransactions();
            const updated = [transaction, ...current].sort((a, b) => b.date - a.date);
            localStorage.setItem(STORAGE_KEY_TX, JSON.stringify(updated));
            return updated;
        };
        const deleteTransaction = (id) => {
            const current = getTransactions();
            const updated = current.filter(t => t.id !== id);
            localStorage.setItem(STORAGE_KEY_TX, JSON.stringify(updated));
            return updated;
        };
        const getCategories = () => {
            const stored = localStorage.getItem(STORAGE_KEY_CATS);
            if (!stored) { localStorage.setItem(STORAGE_KEY_CATS, JSON.stringify(DEFAULT_CATEGORIES)); return DEFAULT_CATEGORIES; }
            return JSON.parse(stored);
        };
        const addCategory = (category) => {
            const current = getCategories();
            const updated = [...current, category];
            localStorage.setItem(STORAGE_KEY_CATS, JSON.stringify(updated));
            return updated;
        };
        const deleteCategory = (id) => {
            const current = getCategories();
            const updated = current.filter(c => c.id !== id);
            localStorage.setItem(STORAGE_KEY_CATS, JSON.stringify(updated));
            return updated;
        };

        const calculateStatsFromList = (filteredTx) => {
            let totalIncome = 0, totalExpense = 0, investmentAmount = 0;
            const categoryBreakdown = { [MacroCategory.SURVIVAL]: 0, [MacroCategory.DAILY_FOOD]: 0, [MacroCategory.ENJOYMENT]: 0, [MacroCategory.NECESSARY]: 0, [MacroCategory.INVESTMENT]: 0 };
            const specificCategoryBreakdown = {};
            filteredTx.forEach(t => {
                if (t.type === TransactionType.INCOME) totalIncome += t.amount;
                else if (t.type === TransactionType.EXPENSE) {
                    totalExpense += t.amount;
                    if (categoryBreakdown[t.macroCategory] !== undefined) categoryBreakdown[t.macroCategory] += t.amount;
                    specificCategoryBreakdown[t.categoryId] = (specificCategoryBreakdown[t.categoryId] || 0) + t.amount;
                    if (t.macroCategory === MacroCategory.INVESTMENT) investmentAmount += t.amount;
                }
            });
            const consumption = totalExpense - investmentAmount;
            const trueSavings = totalIncome - consumption;
            return {
                totalIncome, totalExpense, savings: trueSavings,
                savingsRate: totalIncome > 0 ? trueSavings / totalIncome : 0,
                investmentAmount,
                investmentRate: totalIncome > 0 ? investmentAmount / totalIncome : 0,
                categoryBreakdown, specificCategoryBreakdown
            };
        };
        const calculateMonthlyStats = (transactions, targetDate) => {
            const monthlyTx = transactions.filter(t => { const d = new Date(t.date); return d.getMonth() === targetDate.getMonth() && d.getFullYear() === targetDate.getFullYear(); });
            return calculateStatsFromList(monthlyTx);
        };
        const getPreviousMonthStats = (transactions, currentDate) => {
            const prevDate = new Date(currentDate); prevDate.setMonth(prevDate.getMonth() - 1);
            return calculateMonthlyStats(transactions, prevDate);
        };
        const calculateYearlyStats = (transactions, year) => {
            const yearlyTx = transactions.filter(t => new Date(t.date).getFullYear() === year);
            return calculateStatsFromList(yearlyTx);
        };
        const getAvailableYears = (transactions) => {
            const years = new Set(transactions.map(t => new Date(t.date).getFullYear()));
            years.add(new Date().getFullYear());
            return Array.from(years).sort((a, b) => b - a);
        };

        const generateFinancialReport = async ({ type, stats, prevStats, transactions, dateLabel, userContext }) => {
            const apiKey = window.process?.env?.API_KEY;
            if (!apiKey) throw new Error("API Key is missing.");
            const ai = new GoogleGenAI({ apiKey });
            
            const expenseTx = transactions.filter(t => t.type === 'EXPENSE');
            const maxTx = expenseTx.length > 0 ? expenseTx.reduce((prev, current) => (prev.amount > current.amount) ? prev : current) : null;
            const sortedTransactions = [...transactions].sort((a, b) => b.amount - a.amount).slice(0, 30).map(t => `${new Date(t.date).toLocaleDateString()} - ${t.categoryName}: ${t.amount} [${t.note}]`).join('\n');

            let prompt = `你是一位顶级理财专家...`; // Simplified prompt for brevity in export, but logic is same as source
            if (type === 'monthly') {
                 prompt = `请为我生成【${dateLabel}】的月度财务分析报告。\n用户补充: ${userContext||"无"}\n本月数据:\n总收入:${stats.totalIncome}\n总支出:${stats.totalExpense}\n储蓄:${stats.savings}\n详情:${JSON.stringify(stats.categoryBreakdown)}\n账单样本:\n${sortedTransactions}`;
            } else {
                 prompt = `请为我生成【${dateLabel}】的年度财务报告。\n本年数据:\n总收入:${stats.totalIncome}\n总支出:${stats.totalExpense}\n详情:${JSON.stringify(stats.categoryBreakdown)}\n账单样本:\n${sortedTransactions}`;
            }
            
            const response = await ai.models.generateContent({ model: 'gemini-3-flash-preview', contents: prompt });
            return response.text || "无法生成报告。";
        };

        // --- COMPONENTS ---

        const NumericKeypad = ({ onKeyPress, onDelete, onSubmit, value }) => {
            const keys = ['1', '2', '3', '4', '5', '6', '7', '8', '9', '.', '0', '+', '-'];
            return (
                <div className="bg-[#FDFCF8] pb-8 pt-4 px-6 rounded-t-[40px] shadow-[0_-10px_40px_-15px_rgba(0,0,0,0.1)] relative z-20">
                <div className="flex justify-between items-center mb-6 px-4">
                    <span className="text-xs font-bold text-gray-400 uppercase tracking-widest">Amount</span>
                    <span className="text-4xl font-serif font-bold text-gray-900 break-all">{value || '0.00'}</span>
                </div>
                <div className="grid grid-cols-4 gap-3">
                    {keys.map((key) => (
                    <button key={key} onClick={() => onKeyPress(key)} className="h-16 rounded-[24px] bg-[#F2F0E9] text-2xl font-medium text-gray-700 active:bg-[#E5E2D9] active:scale-95 transition-all shadow-sm border border-black/5">{key}</button>
                    ))}
                    <button onClick={onDelete} className="h-16 rounded-[24px] bg-[#F2F0E9] flex items-center justify-center text-gray-500 active:bg-[#E5E2D9] active:scale-95 transition-all shadow-sm border border-black/5"><Delete size={26} /></button>
                    <button onClick={onSubmit} className="col-span-2 h-16 rounded-[24px] bg-[#1C1917] text-white text-lg font-bold active:scale-95 transition-all flex items-center justify-center gap-3 shadow-lg"><Check size={24} />Done</button>
                </div>
                </div>
            );
        };

        const AddTransaction = ({ isOpen, onClose, onSave, categories, onAddCategory, onDeleteCategory, currentMonthDate, themeColor }) => {
            const [amountStr, setAmountStr] = useState('');
            const [selectedType, setSelectedType] = useState(TransactionType.EXPENSE);
            const [selectedCategory, setSelectedCategory] = useState(null);
            const [customCategoryName, setCustomCategoryName] = useState('');
            const [note, setNote] = useState('');
            const [dateStr, setDateStr] = useState('');
            const [isCreatingCategory, setIsCreatingCategory] = useState(false);
            const [newCatName, setNewCatName] = useState('');
            const [newCatIcon, setNewCatIcon] = useState(AVAILABLE_ICONS[0]);
            const [editingCategoryId, setEditingCategoryId] = useState(null);
            const longPressTimerRef = useRef(null);
            const isLongPressRef = useRef(false);

            useEffect(() => {
                if (isOpen) {
                    setAmountStr(''); setNote(''); setIsCreatingCategory(false); setNewCatName(''); setEditingCategoryId(null);
                    const now = new Date();
                    const isSameMonth = now.getFullYear() === currentMonthDate.getFullYear() && now.getMonth() === currentMonthDate.getMonth();
                    let initialDate = isSameMonth ? now : new Date(currentMonthDate.getFullYear(), currentMonthDate.getMonth(), 1, 12);
                    setDateStr(initialDate.toISOString().split('T')[0]);
                    const first = categories.find(c => c.type === selectedType);
                    if (first) { setSelectedCategory(first); setCustomCategoryName(first.name); } else { setSelectedCategory(null); setCustomCategoryName(''); }
                }
            }, [isOpen, selectedType, categories, currentMonthDate]);

            if (!isOpen) return null;

            const handleKeyPress = (key) => { if (key === '.' && amountStr.includes('.')) return; setAmountStr(prev => prev + key); };
            const handleDeleteDigit = () => setAmountStr(prev => prev.slice(0, -1));
            const handleSubmit = () => {
                if (!selectedCategory) { alert("Please select a category"); return; }
                let finalAmount = 0;
                try { finalAmount = eval(amountStr.replace(/[^-()\d/*+.]/g, '')); } catch (e) { finalAmount = parseFloat(amountStr) || 0; }
                if (finalAmount <= 0) return;
                const [year, month, day] = dateStr.split('-').map(Number);
                const newTransaction = {
                    id: Date.now().toString(), amount: Number(finalAmount.toFixed(2)), type: selectedType, categoryId: selectedCategory.id,
                    categoryName: customCategoryName || selectedCategory.name, macroCategory: selectedCategory.macroCategory, note, date: new Date(year, month - 1, day).getTime(),
                };
                onSave(newTransaction); onClose();
            };

            const startPress = (cat) => {
                isLongPressRef.current = false;
                longPressTimerRef.current = window.setTimeout(() => { isLongPressRef.current = true; setEditingCategoryId(cat.id); if (navigator.vibrate) navigator.vibrate(50); }, 500);
            };
            const cancelPress = () => { if (longPressTimerRef.current) { clearTimeout(longPressTimerRef.current); longPressTimerRef.current = null; } };
            const handleCategoryClick = (cat, e) => { e.stopPropagation(); if (isLongPressRef.current) return; if(editingCategoryId) { setEditingCategoryId(null); return; } setSelectedCategory(cat); setCustomCategoryName(cat.name); };
            const confirmDeleteCategory = (e, id) => { e.stopPropagation(); onDeleteCategory(id); setEditingCategoryId(null); if (selectedCategory?.id === id) { setSelectedCategory(null); setCustomCategoryName(''); } };
            const handleSaveNewCategory = () => {
                if (!newCatName.trim()) { alert('Please enter a name'); return; }
                const newCat = { id: Date.now().toString(), name: newCatName.trim(), icon: newCatIcon, type: selectedType, macroCategory: selectedType === TransactionType.INCOME ? MacroCategory.INCOME : selectedType === TransactionType.TRANSFER ? MacroCategory.TRANSFER : MacroCategory.NECESSARY };
                onAddCategory(newCat); setIsCreatingCategory(false); setSelectedCategory(newCat); setCustomCategoryName(newCat.name);
            };

            return (
                <div className="fixed inset-0 z-50 flex flex-col bg-[#F2F0E9] h-full font-sans">
                <div className="flex justify-between items-center px-6 py-5 bg-[#F2F0E9] relative z-10">
                    {isCreatingCategory ? ( <button onClick={() => setIsCreatingCategory(false)} className="flex items-center text-gray-800 gap-2 font-bold hover:bg-black/5 p-2 rounded-xl"><ArrowLeft size={20} /><span className="text-sm">Back</span></button> ) : ( <button onClick={onClose} className="hover:bg-black/5 p-2 rounded-full"><X size={24} className="text-gray-800" /></button> )}
                    {!isCreatingCategory && (
                    <div className="flex bg-[#E5E2D9] rounded-2xl p-1.5">
                        {[TransactionType.EXPENSE, TransactionType.INCOME, TransactionType.TRANSFER].map(type => (
                        <button key={type} onClick={() => { setSelectedType(type); setSelectedCategory(null); setEditingCategoryId(null); }} className={`px-5 py-2 rounded-xl text-sm font-bold transition-all ${selectedType === type ? 'bg-white text-black shadow-sm' : 'text-gray-500 hover:text-gray-700'}`}>{type === TransactionType.EXPENSE ? '支出' : type === TransactionType.INCOME ? '收入' : '转账'}</button>
                        ))}
                    </div>
                    )}
                    {isCreatingCategory && <div className="font-serif font-bold text-gray-800 text-lg">New Category</div>}
                    <div className="w-6"></div>
                </div>
                {isCreatingCategory ? (
                    <div className="flex-1 flex flex-col p-6 space-y-6 overflow-y-auto">
                    <div className="flex items-center gap-4 bg-[#FDFCF8] p-5 rounded-[24px] shadow-sm">
                        <div className="p-4 rounded-2xl" style={{ backgroundColor: hexToRgba(themeColor, 0.1), color: themeColor }}>{getIconComponent(newCatIcon, 28)}</div>
                        <input autoFocus type="text" value={newCatName} onChange={e => setNewCatName(e.target.value)} placeholder="Category Name" className="flex-1 text-xl font-serif font-bold outline-none text-gray-800 bg-transparent" />
                    </div>
                    <div>
                        <div className="text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-4">Select Icon</div>
                        <div className="grid grid-cols-6 gap-3">{AVAILABLE_ICONS.map(icon => (<button key={icon} onClick={() => setNewCatIcon(icon)} className={`aspect-square flex items-center justify-center rounded-2xl transition-all ${newCatIcon === icon ? 'text-white shadow-lg scale-105' : 'bg-white text-gray-400 hover:bg-[#E5E2D9]'}`} style={newCatIcon === icon ? { backgroundColor: themeColor } : {}}>{getIconComponent(icon, 20)}</button>))}</div>
                    </div>
                    <button onClick={handleSaveNewCategory} className="w-full py-4 text-white rounded-2xl font-bold text-lg mt-auto shadow-xl tracking-wide uppercase" style={{ backgroundColor: themeColor }}>Save Category</button>
                    </div>
                ) : (
                    <>
                    <div className="flex-1 overflow-y-auto p-6" onClick={() => setEditingCategoryId(null)}>
                        <div className="grid grid-cols-4 gap-4 pb-20">
                        {categories.filter(c => c.type === selectedType).map(cat => (
                            <div key={cat.id} className="relative group select-none" onMouseDown={() => startPress(cat)} onMouseUp={cancelPress} onMouseLeave={cancelPress} onTouchStart={() => startPress(cat)} onTouchEnd={cancelPress} onTouchMove={cancelPress} onContextMenu={e => e.preventDefault()}>
                                <button onClick={(e) => handleCategoryClick(cat, e)} className={`w-full flex flex-col items-center gap-2 p-3 rounded-[20px] transition-all relative ${selectedCategory?.id === cat.id ? 'bg-white ring-2 ring-offset-2 ring-offset-[#F2F0E9] shadow-md' : 'hover:bg-white/60'} ${editingCategoryId === cat.id ? 'animate-shake' : ''}`} style={selectedCategory?.id === cat.id ? { borderColor: themeColor, '--tw-ring-color': themeColor } : {}}>
                                <div className={`p-3.5 rounded-[16px] ${selectedCategory?.id === cat.id ? 'text-white' : 'bg-[#FDFCF8] text-gray-400'}`} style={selectedCategory?.id === cat.id ? { backgroundColor: themeColor } : {}}>{getIconComponent(cat.icon, 22)}</div>
                                <span className="text-xs text-center font-bold truncate w-full text-gray-800">{cat.name}</span>
                                {editingCategoryId === cat.id && (<div className="absolute -top-2 -right-2 z-20 animate-in zoom-in duration-200" onClick={(e) => confirmDeleteCategory(e, cat.id)}><div className="bg-red-500 text-white rounded-full p-1.5 shadow-md border-2 border-[#F2F0E9]"><X size={14} strokeWidth={3} /></div></div>)}
                                </button>
                            </div>
                        ))}
                        <button onClick={() => { setIsCreatingCategory(true); setEditingCategoryId(null); }} className="flex flex-col items-center gap-2 p-3 rounded-[20px] hover:bg-white/60 transition-colors"><div className="p-3.5 rounded-[16px] text-gray-400 border-2 border-dashed border-gray-300"><Plus size={22} /></div><span className="text-xs text-center font-bold text-gray-400">Add</span></button>
                        </div>
                    </div>
                    <div className="px-6 py-4 bg-[#F2F0E9]">
                        <div className="bg-[#FDFCF8] rounded-[28px] p-2 shadow-sm space-y-2">
                        {selectedCategory && ( <div className="flex items-center gap-3 bg-gray-50 px-4 py-3 rounded-2xl border border-gray-100"><div style={{ color: themeColor }}>{getIconComponent(selectedCategory.icon, 20)}</div><input type="text" value={customCategoryName} onChange={(e) => setCustomCategoryName(e.target.value)} className="bg-transparent text-sm font-bold w-full outline-none text-gray-800" placeholder="Category Name" /></div> )}
                        <div className="flex gap-2">
                            <div className="flex-1 flex items-center gap-3 bg-gray-50 px-4 py-3 rounded-2xl border border-gray-100"><Edit3 size={18} className="text-gray-400" /><input type="text" placeholder="Add a note..." value={note} onChange={(e) => setNote(e.target.value)} className="bg-transparent text-sm font-medium w-full outline-none placeholder:text-gray-400" /></div>
                            <div className="relative flex items-center gap-2 bg-gray-50 px-4 py-3 rounded-2xl border border-gray-100 min-w-[140px]"><Calendar size={18} className="text-gray-400 pointer-events-none" /><input type="date" required value={dateStr} onChange={(e) => setDateStr(e.target.value)} className="bg-transparent text-sm font-bold text-gray-700 outline-none w-full appearance-none" /></div>
                        </div>
                        </div>
                    </div>
                    <NumericKeypad onKeyPress={handleKeyPress} onDelete={handleDeleteDigit} onSubmit={handleSubmit} value={amountStr} />
                    </>
                )}
                </div>
            );
        };

        const SwipeableTransactionItem = ({ transaction: t, category, trendIcon, onDelete, isOpen, onSwipeOpen, onSwipeClose, isLast }) => {
            const icon = category ? category.icon : 'Wallet';
            const tDate = new Date(t.date);
            const formattedDate = `${tDate.getMonth() + 1}/${tDate.getDate()}`;
            const [dragOffset, setDragOffset] = useState(0);
            const touchStartX = useRef(null);
            
            useEffect(() => setDragOffset(0), [isOpen]);

            const handleTouchStart = (e) => { touchStartX.current = e.touches[0].clientX; };
            const handleTouchMove = (e) => {
                if (touchStartX.current === null) return;
                const diff = e.touches[0].clientX - touchStartX.current;
                if (!isOpen) { if (diff < 0 && diff > -100) setDragOffset(diff); } 
                else { if (diff > 0 && diff < 100) setDragOffset(diff); }
            };
            const handleTouchEnd = () => {
                if (touchStartX.current === null) return;
                if (!isOpen) { if (dragOffset < -40) onSwipeOpen(t.id); else setDragOffset(0); } 
                else { if (dragOffset > 40) onSwipeClose(); else setDragOffset(0); }
                touchStartX.current = null;
            };

            const baseOffset = isOpen ? -80 : 0;
            let visualOffset = baseOffset + dragOffset;
            if (visualOffset < -80) visualOffset = -80; if (visualOffset > 0) visualOffset = 0;

            return (
                <div className="relative overflow-hidden w-full">
                <div className={`absolute inset-y-0 right-0 w-[80px] bg-red-500 flex items-center justify-center text-white z-0 ${isLast ? 'rounded-br-[32px]' : ''}`}><button onClick={() => onDelete(t.id)} className="w-full h-full flex items-center justify-center"><Trash2 size={24} /></button></div>
                <div className={`bg-[#FDFCF8] relative z-10 w-full ${!touchStartX.current ? 'transition-transform duration-300 ease-out' : ''} ${!isLast ? 'border-b border-gray-50' : ''}`} style={{ transform: `translateX(${visualOffset}px)` }} onTouchStart={handleTouchStart} onTouchMove={handleTouchMove} onTouchEnd={handleTouchEnd}>
                    <div className="p-5 flex items-center justify-between hover:bg-[#F9F8F6] group transition-colors">
                    <div className="flex items-center gap-4">
                        <div className="w-12 h-12 rounded-[18px] flex items-center justify-center text-white shadow-md" style={{ backgroundColor: getCategoryColor(t.categoryId) }}>{getIconComponent(icon, 20)}</div>
                        <div>
                            <div className="font-bold text-gray-800 text-base flex items-center gap-1.5">{t.categoryName}{trendIcon && <div className="ml-0.5 transform scale-90">{trendIcon}</div>}</div>
                            <div className="text-xs text-gray-400 flex items-center gap-2 mt-0.5 font-medium"><span className="bg-gray-100 px-1.5 py-0.5 rounded text-gray-500">{formattedDate}</span>{t.note && <span className="truncate max-w-[120px]">{t.note}</span>}</div>
                        </div>
                    </div>
                    <div className={`font-serif font-bold text-base ${t.type === 'INCOME' ? 'text-[#2A9D8F]' : 'text-gray-900'}`}>{t.type === 'INCOME' ? '+' : '-'}{t.amount.toFixed(2)}</div>
                    </div>
                </div>
                </div>
            );
        };

        const App = () => {
            const [transactions, setTransactions] = useState([]);
            const [categories, setCategoriesState] = useState([]);
            const [isAddModalOpen, setIsAddModalOpen] = useState(false);
            const [activeTab, setActiveTab] = useState('dashboard');
            const [themeColor, setThemeColor] = useState('#1C1917');
            const [showColorPicker, setShowColorPicker] = useState(false);
            const [selectedDate, setSelectedDate] = useState(new Date());
            const [openSwipeId, setOpenSwipeId] = useState(null);
            const [reportType, setReportType] = useState('monthly');
            const [reportYear, setReportYear] = useState(new Date().getFullYear());
            const [userContext, setUserContext] = useState('');
            const [report, setReport] = useState(null);
            const [loadingReport, setLoadingReport] = useState(false);
            const [apiKeyMissing, setApiKeyMissing] = useState(false);

            useEffect(() => {
                setTransactions(getTransactions());
                setCategoriesState(getCategories());
                if (!window.process?.env?.API_KEY) setApiKeyMissing(true);
                const savedTheme = localStorage.getItem('wealthgrows_theme');
                if (savedTheme) setThemeColor(savedTheme);
            }, []);

            const dashboardStats = useMemo(() => calculateMonthlyStats(transactions, selectedDate), [transactions, selectedDate]);
            const prevDashboardStats = useMemo(() => getPreviousMonthStats(transactions, selectedDate), [transactions, selectedDate]);
            const displayTransactions = useMemo(() => transactions.filter(t => { const d = new Date(t.date); return d.getMonth() === selectedDate.getMonth() && d.getFullYear() === selectedDate.getFullYear(); }), [transactions, selectedDate]);
            const availableYears = useMemo(() => getAvailableYears(transactions), [transactions]);

            const pieData = Object.entries(dashboardStats.categoryBreakdown).filter(([_, v]) => v > 0).map(([n, v]) => ({ name: n, value: v }));
            const getTrendIcon = (curr, prev) => { if (!prev || curr - prev === 0) return null; const isInc = curr - prev > 0; const Icon = isInc ? ArrowUpRight : ArrowDownRight; return <div className={`w-4 h-4 rounded-full flex items-center justify-center text-white ${isInc ? 'bg-[#BC4749]' : 'bg-[#2A9D8F]'}`}><Icon size={10} strokeWidth={3} /></div>; };
            const PRESET_COLORS = ['#1C1917', '#264653', '#2A9D8F', '#BC4749', '#D4A373', '#6D597A'];

            return (
                <div className="min-h-screen max-w-md mx-auto bg-[#F2F0E9] flex flex-col relative shadow-2xl overflow-hidden font-sans">
                <header className="px-8 pt-12 pb-6 flex justify-between items-center z-10 sticky top-0 bg-[#F2F0E9]/95 backdrop-blur-sm">
                    <div>
                    <div className="flex items-center gap-2"><h1 className="text-3xl font-serif font-bold tracking-tight text-gray-900" style={{ color: themeColor }}>这日子还过吗</h1><button onClick={() => setShowColorPicker(true)} className="p-1.5 rounded-full hover:bg-black/5"><Palette size={16} style={{ color: themeColor, opacity: 0.8 }} /></button></div>
                    <p className="text-xs text-gray-500 mt-1 uppercase tracking-widest font-medium">Rational • Long-term</p>
                    </div>
                    <div className="relative group"><div className="flex items-center gap-2 bg-white px-4 py-2 rounded-full shadow-sm border border-black/5"><span className="text-sm font-bold text-gray-800 font-serif">{selectedDate.getFullYear()}.{String(selectedDate.getMonth() + 1).padStart(2, '0')}</span><ChevronDown size={14} className="text-gray-400"/></div><input type="month" className="absolute inset-0 opacity-0 cursor-pointer" onChange={e => e.target.value && setSelectedDate(new Date(e.target.value))} value={`${selectedDate.getFullYear()}-${String(selectedDate.getMonth() + 1).padStart(2, '0')}`} /></div>
                </header>
                <main className="flex-1 overflow-y-auto no-scrollbar pb-36 px-6">
                    <div className="flex p-1.5 gap-2 bg-gray-200/50 rounded-full mb-6">
                    <button onClick={() => setActiveTab('dashboard')} className={`flex-1 py-2.5 rounded-full flex items-center justify-center gap-2 text-sm font-bold transition-all ${activeTab === 'dashboard' ? 'text-white shadow-md' : 'text-gray-500'}`} style={activeTab === 'dashboard' ? { backgroundColor: themeColor } : {}}><Wallet size={16} />月度概览</button>
                    <button onClick={() => setActiveTab('report')} className={`flex-1 py-2.5 rounded-full flex items-center justify-center gap-2 text-sm font-bold transition-all ${activeTab === 'report' ? 'text-white shadow-md' : 'text-gray-500'}`} style={activeTab === 'report' ? { backgroundColor: themeColor } : {}}><Sparkles size={16} />AI 分析师</button>
                    </div>
                    {activeTab === 'dashboard' ? (
                    <div className="space-y-6">
                        <div className="p-6 rounded-[32px] shadow-lg text-white relative overflow-hidden" style={{ backgroundColor: themeColor }}>
                        <div className="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/cubes.png')] opacity-10 mix-blend-overlay"></div>
                        <div className="relative z-10">
                            <div className="flex justify-between items-start mb-6"><div><span className="text-xs font-bold tracking-widest text-white/70 uppercase">Total Saving</span><div className="text-4xl font-serif font-medium mt-1">{dashboardStats.savings >= 0 ? '+' : ''}{dashboardStats.savings.toFixed(2)}</div></div><div className="bg-white/20 p-2 rounded-full backdrop-blur-md"><TrendingUp size={24} className="text-white" /></div></div>
                            <div className="flex gap-8 border-t border-white/20 pt-4"><div><div className="text-[10px] text-white/70 uppercase tracking-wider mb-1">Savings Rate</div><div className="font-serif text-xl">{(dashboardStats.savingsRate * 100).toFixed(0)}%</div></div><div><div className="text-[10px] text-white/70 uppercase tracking-wider mb-1">Invest Rate</div><div className="font-serif text-xl">{(dashboardStats.investmentRate * 100).toFixed(0)}%</div></div></div>
                        </div>
                        </div>
                        <div className="grid grid-cols-2 gap-4">
                        <div className="bg-[#FDFCF8] p-5 rounded-[28px] shadow-sm"><span className="text-xs text-gray-400 font-bold uppercase tracking-wider">Income</span><div className="text-2xl font-serif text-gray-800 mt-2 flex items-center gap-1"><span className="text-[#2A9D8F] text-sm bg-[#2A9D8F]/10 p-1 rounded-full"><ArrowUp size={12}/></span>{dashboardStats.totalIncome.toFixed(0)}</div></div>
                        <div className="bg-[#FDFCF8] p-5 rounded-[28px] shadow-sm"><span className="text-xs text-gray-400 font-bold uppercase tracking-wider">Expense</span><div className="text-2xl font-serif text-gray-800 mt-2 flex items-center gap-1"><span className="text-[#BC4749] text-sm bg-[#BC4749]/10 p-1 rounded-full"><ArrowDown size={12}/></span>{dashboardStats.totalExpense.toFixed(0)}</div></div>
                        </div>
                        {dashboardStats.totalExpense > 0 && (
                        <div className="bg-[#FDFCF8] p-6 rounded-[32px] shadow-sm"><h3 className="text-lg font-serif font-bold text-gray-800 mb-6 flex items-center gap-2">消费结构</h3><div className="h-48 w-full relative"><ResponsiveContainer><RechartsPie><Pie data={pieData} innerRadius={60} outerRadius={80} paddingAngle={5} dataKey="value" stroke="none" cornerRadius={4}>{pieData.map((e, i) => <Cell key={i} fill={MACRO_COLORS[e.name] || '#ccc'} />)}</Pie><Tooltip /></RechartsPie></ResponsiveContainer><div className="absolute inset-0 flex items-center justify-center pointer-events-none"><div className="text-center"><div className="text-[10px] text-gray-400 uppercase tracking-wide">Total</div><div className="font-serif font-bold text-gray-800 text-xl">{dashboardStats.totalExpense.toFixed(0)}</div></div></div></div><div className="mt-8 flex flex-wrap gap-2 justify-center">{pieData.map(d => (<div key={d.name} className="flex items-center gap-2 text-xs text-gray-600 bg-[#F2F0E9] px-3 py-1.5 rounded-full border border-black/5"><div className="w-2 h-2 rounded-full" style={{ backgroundColor: MACRO_COLORS[d.name]}}></div><span className="font-medium">{d.name}</span><span className="font-bold border-l border-gray-300 ml-1 pl-1">{(d.value/dashboardStats.totalExpense*100).toFixed(0)}%</span></div>))}</div></div>
                        )}
                        <div className="bg-[#FDFCF8] rounded-[32px] shadow-sm overflow-hidden pb-4 min-h-[200px]">
                        <div className="p-6 border-b border-gray-100/50 flex justify-between items-center"><h3 className="font-serif font-bold text-lg text-gray-800">近期账单</h3><span className="text-xs text-gray-400 font-medium bg-gray-100 px-2 py-1 rounded-md">Latest</span></div>
                        <div className="flex flex-col">
                            {displayTransactions.length === 0 ? <div className="p-10 text-center text-gray-400 text-sm flex flex-col items-center gap-2"><div className="w-12 h-12 bg-gray-100 rounded-full flex items-center justify-center text-gray-300"><FileText size={20}/></div>本月暂无记录</div> : displayTransactions.map((t, idx) => (
                            <SwipeableTransactionItem key={t.id} transaction={t} category={categories.find(c => c.id === t.categoryId)} trendIcon={t.type === 'EXPENSE' ? getTrendIcon(dashboardStats.specificCategoryBreakdown[t.categoryId], prevDashboardStats.specificCategoryBreakdown[t.categoryId]) : null} onDelete={() => { deleteTransaction(t.id); setTransactions(getTransactions()); }} isOpen={openSwipeId === t.id} onSwipeOpen={(id) => setOpenSwipeId(id)} onSwipeClose={() => setOpenSwipeId(null)} isLast={idx === displayTransactions.length - 1} />
                            ))}
                        </div>
                        </div>
                    </div>
                    ) : (
                    <div className="pb-12">
                        <div className="bg-[#FDFCF8] rounded-[32px] p-6 shadow-sm mb-6 space-y-5">
                        <div className="flex bg-[#F2F0E9] p-1.5 rounded-2xl"><button onClick={() => setReportType('monthly')} className={`flex-1 py-3 rounded-xl text-sm font-bold transition-all ${reportType === 'monthly' ? 'bg-white shadow-sm' : 'text-gray-400'}`} style={reportType === 'monthly' ? { color: themeColor } : {}}>月度报告</button><button onClick={() => setReportType('yearly')} className={`flex-1 py-3 rounded-xl text-sm font-bold transition-all ${reportType === 'yearly' ? 'bg-white shadow-sm' : 'text-gray-400'}`} style={reportType === 'yearly' ? { color: themeColor } : {}}>年度报告</button></div>
                        <div className="space-y-4">
                            {reportType === 'monthly' ? ( <div className="flex items-center gap-3 text-sm text-gray-600 bg-white px-4 py-4 rounded-2xl border border-gray-100"><div className="bg-gray-100 p-2 rounded-full"><Calendar size={16} /></div><div><span className="block text-xs text-gray-400 uppercase tracking-wider">Target Period</span><span className="font-serif font-bold text-gray-900 text-lg">{selectedDate.getFullYear()}.{String(selectedDate.getMonth() + 1).padStart(2, '0')}</span></div></div> ) : ( <div className="flex items-center gap-3 text-sm text-gray-600 bg-white px-4 py-4 rounded-2xl border border-gray-100 relative"><div className="bg-gray-100 p-2 rounded-full"><CalendarDays size={16} /></div><div className="flex-1"><span className="block text-xs text-gray-400 uppercase tracking-wider">Target Year</span><select value={reportYear} onChange={(e) => setReportYear(Number(e.target.value))} className="bg-transparent font-serif font-bold text-gray-900 text-lg outline-none appearance-none w-full relative z-10">{availableYears.map(y => <option key={y} value={y}>{y}</option>)}</select></div><ChevronDown size={14} className="absolute right-4 text-gray-400" /></div> )}
                            <textarea value={userContext} onChange={(e) => setUserContext(e.target.value)} placeholder="Tell me about any big changes..." className="w-full bg-white rounded-2xl py-4 px-4 text-sm outline-none focus:ring-2 border border-gray-100 min-h-[100px] resize-none" style={{ '--tw-ring-color': hexToRgba(themeColor, 0.2) }} />
                        </div>
                        {apiKeyMissing ? <div className="bg-amber-50 p-4 rounded-2xl flex items-start gap-3 border border-amber-100"><AlertCircle className="shrink-0 text-amber-500" size={20} /><div className="text-xs text-amber-800">API Key Missing</div></div> : <button onClick={async () => { setLoadingReport(true); try { const r = await generateFinancialReport({ type: reportType, stats: dashboardStats, prevStats: prevDashboardStats, transactions: displayTransactions, dateLabel: reportType === 'monthly' ? `${selectedDate.getFullYear()}-${selectedDate.getMonth()+1}` : `${reportYear}`, userContext }); setReport(r); } catch(e) { setReport("Error"); } setLoadingReport(false); }} disabled={loadingReport} className="w-full text-white font-bold py-4 rounded-2xl active:scale-[0.98] transition-all flex justify-center items-center gap-3 shadow-xl" style={{ backgroundColor: themeColor }}>{loadingReport ? 'Analyzing...' : <><Sparkles size={20} />生成诊断报告</>}</button>}
                        </div>
                        {report && <div className="bg-[#FDFCF8] rounded-[32px] p-8 shadow-sm markdown-body space-y-6 animate-in fade-in slide-in-from-bottom-4 duration-700"><div className="flex items-center gap-3 mb-4 pb-4 border-b border-gray-100"><div className="p-3 rounded-full" style={{ backgroundColor: hexToRgba(themeColor, 0.1), color: themeColor }}><TrendingUp size={24} /></div><h3 className="font-serif font-bold text-gray-800 text-2xl">Analysis Report</h3></div><pre className="whitespace-pre-wrap font-sans text-sm text-gray-600 leading-8 tracking-wide">{report}</pre></div>}
                    </div>
                    )}
                </main>
                <div className="fixed bottom-8 left-0 right-0 flex justify-center pointer-events-none z-50"><button onClick={() => setIsAddModalOpen(true)} className="pointer-events-auto text-white w-18 h-18 p-5 rounded-full shadow-2xl flex items-center justify-center hover:scale-110 transition-transform active:scale-95" style={{ backgroundColor: themeColor, boxShadow: `0 15px 35px -5px ${hexToRgba(themeColor, 0.5)}` }}><Plus size={36} /></button></div>
                <AddTransaction isOpen={isAddModalOpen} onClose={() => setIsAddModalOpen(false)} onSave={(t) => { saveTransaction(t); setTransactions(getTransactions()); }} categories={categories} onAddCategory={(c) => setCategoriesState(addCategory(c))} onDeleteCategory={(id) => setCategoriesState(deleteCategory(id))} currentMonthDate={selectedDate} themeColor={themeColor} />
                {showColorPicker && <div className="fixed inset-0 z-[60] flex items-center justify-center bg-[#F2F0E9]/80 backdrop-blur-md" onClick={() => setShowColorPicker(false)}><div className="bg-[#FDFCF8] p-8 rounded-[40px] shadow-2xl w-80 space-y-8 animate-in zoom-in-95 duration-200" onClick={e => e.stopPropagation()}><div className="flex justify-between items-center"><h3 className="font-serif font-bold text-gray-800 text-xl">App Theme</h3><button onClick={() => setShowColorPicker(false)}><X size={24}/></button></div><div className="grid grid-cols-3 gap-4">{PRESET_COLORS.map(c => <button key={c} onClick={() => { setThemeColor(c); localStorage.setItem('wealthgrows_theme', c); setShowColorPicker(false); }} className="w-16 h-16 rounded-full border border-gray-100 shadow-sm" style={{ backgroundColor: c }}>{themeColor.toLowerCase() === c.toLowerCase() && <Check size={24} className="text-white mx-auto" />}</button>)}</div></div></div>}
                </div>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>