<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>WealthGrows - 这日子还过吗</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
      @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Playfair+Display:ital,wght@0,400;0,600;0,700;1,400&display=swap');
      
      body {
        font-family: 'Inter', sans-serif;
        background-color: #F2F0E9;
        color: #1C1917;
      }
      
      .font-serif {
        font-family: 'Playfair Display', serif;
      }

      .no-scrollbar::-webkit-scrollbar {
        display: none;
      }
      .no-scrollbar {
        -ms-overflow-style: none;
        scrollbar-width: none;
      }

      @keyframes shake {
        0% { transform: rotate(0deg); }
        25% { transform: rotate(2deg); }
        50% { transform: rotate(0deg); }
        75% { transform: rotate(-2deg); }
        100% { transform: rotate(0deg); }
      }
      
      .animate-shake {
        animation: shake 0.2s ease-in-out infinite;
      }
      
      /* Markdown basic styles for report */
      .markdown-body h1, .markdown-body h2, .markdown-body h3 { font-family: 'Playfair Display', serif; margin-top: 1.2em; margin-bottom: 0.6em; font-weight: bold; border-bottom: 1px solid rgba(0,0,0,0.05); padding-bottom: 0.3em; }
      .markdown-body ul { list-style-type: disc; padding-left: 1.5em; margin-bottom: 1em; }
      .markdown-body li { margin-bottom: 0.5em; }
      .markdown-body p { margin-bottom: 1em; line-height: 1.6; }
      .markdown-body strong { font-weight: 700; color: #1C1917; }
    </style>
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "lucide-react": "https://esm.sh/lucide-react@0.292.0",
        "recharts": "https://esm.sh/recharts@2.12.0",
        "@google/genai": "https://esm.sh/@google/genai@0.1.1"
      }
    }
    </script>
</head>
<body>
    <div id="root"></div>
    
    <!-- Shim for process.env -->
    <script>
        window.process = { env: { API_KEY: '' } }; // 用户需在此处填入 API Key
    </script>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef, useMemo } from 'react';
        import { createRoot } from 'react-dom/client';
        import * as Lucide from 'lucide-react';
        import { ResponsiveContainer, PieChart as RechartsPie, Pie, Cell, Tooltip } from 'recharts';
        import { GoogleGenAI } from '@google/genai';

        const { 
            Plus, Wallet, PieChart, Sparkles, TrendingUp, AlertCircle, ArrowUpRight, ArrowDownRight, 
            ChevronDown, CalendarDays, FileText, Calendar, ArrowUp, ArrowDown, Palette, Check, X, 
            Trash2, MinusCircle, Edit3, ArrowLeft, Delete, ChevronUp,
            Utensils, Bus, ShoppingBag, Gamepad2, Stethoscope, GraduationCap, Home, Briefcase, 
            HeartHandshake, Banknote, Car, Plane, Gift, Smartphone, Coffee, Dumbbell, PawPrint, Music,
            Zap, Droplet, Wifi, ShoppingCart, Film, Book, Wrench, Hammer, Baby, Beer, 
            Scissors, Shirt, Watch, Smile, Star, Heart, Sun, Moon, Cloud, Umbrella, Key,
            Laptop, Camera, Bike, Bed, Sofa, Bath
        } = Lucide;

        // --- TYPES & CONSTANTS ---
        const TransactionType = { EXPENSE: 'EXPENSE', INCOME: 'INCOME', TRANSFER: 'TRANSFER' };
        const MacroCategory = {
            SURVIVAL: '固定生存成本', DAILY_FOOD: '吃喝日常', ENJOYMENT: '享受型消费',
            NECESSARY: '必要支出', INVESTMENT: '投资理财', INCOME: '收入', TRANSFER: '转账'
        };

        const AVAILABLE_ICONS = [
            'Utensils', 'Coffee', 'Beer', 'ShoppingBag', 'ShoppingCart', 'Shirt', 'Watch', 'Gift', 
            'Bus', 'Car', 'Plane', 'Bike', 'Home', 'Bed', 'Sofa', 'Bath', 'Zap', 'Droplet', 'Wifi',
            'Gamepad2', 'Film', 'Music', 'Camera', 'Dumbbell', 'PawPrint', 'Baby', 'Smile', 'Heart',
            'Stethoscope', 'GraduationCap', 'Book', 'Briefcase', 'Laptop', 'Smartphone', 'Wrench', 'Hammer',
            'TrendingUp', 'Banknote', 'Wallet', 'Key', 'Sun', 'Moon', 'Star', 'Cloud', 'Umbrella'
        ];

        const DEFAULT_CATEGORIES = [
            { id: 'food', name: '餐饮', icon: 'Utensils', type: TransactionType.EXPENSE, macroCategory: MacroCategory.DAILY_FOOD },
            { id: 'transport', name: '交通', icon: 'Bus', type: TransactionType.EXPENSE, macroCategory: MacroCategory.NECESSARY },
            { id: 'shopping', name: '购物', icon: 'ShoppingBag', type: TransactionType.EXPENSE, macroCategory: MacroCategory.ENJOYMENT },
            { id: 'entertainment', name: '娱乐', icon: 'Gamepad2', type: TransactionType.EXPENSE, macroCategory: MacroCategory.ENJOYMENT },
            { id: 'medical', name: '医疗', icon: 'Stethoscope', type: TransactionType.EXPENSE, macroCategory: MacroCategory.SURVIVAL },
            { id: 'learning', name: '学习', icon: 'GraduationCap', type: TransactionType.EXPENSE, macroCategory: MacroCategory.INVESTMENT },
            { id: 'rent', name: '房租', icon: 'Home', type: TransactionType.EXPENSE, macroCategory: MacroCategory.SURVIVAL },
            { id: 'invest_product', name: '理财', icon: 'TrendingUp', type: TransactionType.EXPENSE, macroCategory: MacroCategory.INVESTMENT },
            { id: 'salary', name: '工资', icon: 'Briefcase', type: TransactionType.INCOME, macroCategory: MacroCategory.INCOME },
            { id: 'bonus', name: '奖金', icon: 'Banknote', type: TransactionType.INCOME, macroCategory: MacroCategory.INCOME },
            { id: 'invest_return', name: '投资回报', icon: 'TrendingUp', type: TransactionType.INCOME, macroCategory: MacroCategory.INCOME },
            { id: 'part_time', name: '兼职', icon: 'Wallet', type: TransactionType.INCOME, macroCategory: MacroCategory.INCOME },
            { id: 'transfer', name: '转账', icon: 'HeartHandshake', type: TransactionType.TRANSFER, macroCategory: MacroCategory.TRANSFER },
        ];

        const getIconComponent = (iconName, size = 20, color) => {
             const props = { size, color };
             const Icon = Lucide[iconName] || Lucide.Wallet;
             return <Icon {...props} />;
        };

        const MACRO_COLORS = {
            [MacroCategory.SURVIVAL]: '#6B705C',
            [MacroCategory.DAILY_FOOD]: '#D4A373',
            [MacroCategory.ENJOYMENT]: '#BC4749',
            [MacroCategory.NECESSARY]: '#457B9D',
            [MacroCategory.INVESTMENT]: '#2A9D8F',
            [MacroCategory.INCOME]: '#6D597A',
            [MacroCategory.TRANSFER]: '#A5A58D',
        };

        const CATEGORY_ICON_COLORS = [
            '#E76F51', '#264653', '#E9C46A', '#F4A261', '#83C5BE', '#006D77',
            '#FFB4A2', '#B5838D', '#6D6875', '#5F0F40', '#9A031E', '#FB8B24'
        ];

        const hexToRgba = (hex, alpha) => {
            let r = 0, g = 0, b = 0;
            if (hex.length === 4) {
                r = parseInt(hex[1] + hex[1], 16); g = parseInt(hex[2] + hex[2], 16); b = parseInt(hex[3] + hex[3], 16);
            } else if (hex.length === 7) {
                r = parseInt(hex.slice(1, 3), 16); g = parseInt(hex.slice(3, 5), 16); b = parseInt(hex.slice(5, 7), 16);
            }
            return `rgba(${r}, ${g}, ${b}, ${alpha})`;
        };

        const getCategoryColor = (id) => {
            let hash = 0;
            for (let i = 0; i < id.length; i++) hash = id.charCodeAt(i) + ((hash << 5) - hash);
            return CATEGORY_ICON_COLORS[Math.abs(hash) % CATEGORY_ICON_COLORS.length];
        };

        // --- SERVICES ---
        const STORAGE_KEY_TX = 'wealthgrows_transactions';
        const STORAGE_KEY_CATS = 'wealthgrows_categories';

        const getTransactions = () => {
            const stored = localStorage.getItem(STORAGE_KEY_TX);
            return stored ? JSON.parse(stored) : [];
        };
        const saveTransaction = (transaction) => {
            const current = getTransactions();
            const updated = [transaction, ...current].sort((a, b) => b.date - a.date);
            localStorage.setItem(STORAGE_KEY_TX, JSON.stringify(updated));
            return updated;
        };
        const deleteTransaction = (id) => {
            const current = getTransactions();
            const updated = current.filter(t => t.id !== id);
            localStorage.setItem(STORAGE_KEY_TX, JSON.stringify(updated));
            return updated;
        };
        const getCategories = () => {
            const stored = localStorage.getItem(STORAGE_KEY_CATS);
            if (!stored) { localStorage.setItem(STORAGE_KEY_CATS, JSON.stringify(DEFAULT_CATEGORIES)); return DEFAULT_CATEGORIES; }
            return JSON.parse(stored);
        };
        const addCategory = (category) => {
            const current = getCategories();
            const updated = [...current, category];
            localStorage.setItem(STORAGE_KEY_CATS, JSON.stringify(updated));
            return updated;
        };
        const deleteCategory = (id) => {
            const current = getCategories();
            const updated = current.filter(c => c.id !== id);
            localStorage.setItem(STORAGE_KEY_CATS, JSON.stringify(updated));
            return updated;
        };

        const calculateStatsFromList = (filteredTx) => {
            let totalIncome = 0, totalExpense = 0, investmentAmount = 0;
            const categoryBreakdown = { [MacroCategory.SURVIVAL]: 0, [MacroCategory.DAILY_FOOD]: 0, [MacroCategory.ENJOYMENT]: 0, [MacroCategory.NECESSARY]: 0, [MacroCategory.INVESTMENT]: 0 };
            const specificCategoryBreakdown = {};
            filteredTx.forEach(t => {
                if (t.type === TransactionType.INCOME) totalIncome += t.amount;
                else if (t.type === TransactionType.EXPENSE) {
                    totalExpense += t.amount;
                    if (categoryBreakdown[t.macroCategory] !== undefined) categoryBreakdown[t.macroCategory] += t.amount;
                    specificCategoryBreakdown[t.categoryId] = (specificCategoryBreakdown[t.categoryId] || 0) + t.amount;
                    if (t.macroCategory === MacroCategory.INVESTMENT) investmentAmount += t.amount;
                }
            });
            const consumption = totalExpense - investmentAmount;
            const trueSavings = totalIncome - consumption;
            return {
                totalIncome, totalExpense, savings: trueSavings,
                savingsRate: totalIncome > 0 ? trueSavings / totalIncome : 0,
                investmentAmount,
                investmentRate: totalIncome > 0 ? investmentAmount / totalIncome : 0,
                categoryBreakdown, specificCategoryBreakdown
            };
        };
        const calculateMonthlyStats = (transactions, targetDate) => {
            const monthlyTx = transactions.filter(t => { const d = new Date(t.date); return d.getMonth() === targetDate.getMonth() && d.getFullYear() === targetDate.getFullYear(); });
            return calculateStatsFromList(monthlyTx);
        };
        const getPreviousMonthStats = (transactions, currentDate) => {
            const prevDate = new Date(currentDate); prevDate.setMonth(prevDate.getMonth() - 1);
            return calculateMonthlyStats(transactions, prevDate);
        };
        const calculateYearlyStats = (transactions, year) => {
            const yearlyTx = transactions.filter(t => new Date(t.date).getFullYear() === year);
            return calculateStatsFromList(yearlyTx);
        };
        const getAvailableYears = (transactions) => {
            const years = new Set(transactions.map(t => new Date(t.date).getFullYear()));
            years.add(new Date().getFullYear());
            return Array.from(years).sort((a, b) => b - a);
        };

        const generateFinancialReport = async ({ type, stats, prevStats, transactions, dateLabel, userContext }) => {
            const apiKey = window.process?.env?.API_KEY;
            if (!apiKey) return "错误：API Key 未配置。";
            const ai = new GoogleGenAI({ apiKey });
            
            const expenseTx = transactions.filter(t => t.type === 'EXPENSE');
            const maxTx = expenseTx.length > 0 ? expenseTx.reduce((prev, current) => (prev.amount > current.amount) ? prev : current) : null;
            const sortedTransactions = [...transactions].sort((a, b) => b.amount - a.amount).slice(0, 30).map(t => `${new Date(t.date).toLocaleDateString()} - ${t.categoryName}: ${t.amount} [${t.note}]`).join('\n');

            const systemInstruction = `你是一位顶级的私人财务管家和理性消费分析师。
你的核心人设：理性、犀利，且深度了解Z时代（Gen Z）的消费观——包括“悦己消费”、私域生活、拒绝消费主义洗脑但愿意为情绪价值买单、追求早日实现财务自由（FIRE）等。
任务目标：
1. 分析用户的财务数据，识别消费中的“坑”或“亮点”。
2. 提供具建设性的、能共情的财务改进建议。
格式要求：不再受限于固定大纲，由你自行组织结构，确保清晰明了、简洁、可读性极高。语言风格应现代、专业且带有Z时代特有的敏锐感。使用 Markdown 格式增强视觉层次感。`;

            let dataPayload = `报告周期：${dateLabel}\n用户补充: ${userContext||"无"}\n本周期概况:\n总收入:${stats.totalIncome.toFixed(2)}\n总支出:${stats.totalExpense.toFixed(2)}\n净储蓄:${stats.savings.toFixed(2)}\n储蓄率:${(stats.savingsRate * 100).toFixed(1)}%\n结构详情:${JSON.stringify(stats.categoryBreakdown)}\n账单样本:\n${sortedTransactions}`;
            
            const response = await ai.models.generateContent({ 
                model: 'gemini-3-flash-preview', 
                contents: dataPayload,
                config: { systemInstruction, temperature: 0.8 }
            });
            return response.text || "无法生成报告。";
        };

        // --- COMPONENTS ---

        const NumericKeypad = ({ onKeyPress, onDelete, onSubmit, value, isMinimized, onToggle, children }) => {
            const keys = ['1', '2', '3', '4', '5', '6', '7', '8', '9', '.', '0', '+', '-'];
            return (
                <div 
                    className={`bg-[#FDFCF8] rounded-t-[40px] shadow-[0_-15px_50px_-15px_rgba(0,0,0,0.15)] relative z-20 transition-all duration-500 ease-in-out ${
                        isMinimized ? 'translate-y-[calc(100%-180px)]' : 'translate-y-0'
                    }`}
                >
                <div className="flex flex-col">
                    <div className="px-6 pt-4">{children}</div>
                    <div className="pt-2 pb-4 px-6 cursor-pointer" onClick={onToggle}>
                        <div className="flex justify-center mb-1"><div className="w-10 h-1 bg-gray-200 rounded-full" /></div>
                        <div className="flex justify-between items-center px-4">
                            <span className="text-[10px] font-bold text-gray-400 uppercase tracking-widest flex items-center gap-1">
                                {isMinimized && <ChevronUp size={12} className="animate-bounce" />} Amount
                            </span>
                            <span className={`font-serif font-bold text-gray-900 break-all transition-all ${isMinimized ? 'text-xl' : 'text-4xl'}`}>{value || '0.00'}</span>
                        </div>
                    </div>
                </div>
                <div className={`px-6 pb-8 transition-opacity duration-300 ${isMinimized ? 'opacity-0 pointer-events-none h-0' : 'opacity-100'}`}>
                    <div className="grid grid-cols-4 gap-3">
                        {keys.map((key) => (<button key={key} onClick={() => onKeyPress(key)} className="h-14 rounded-[20px] bg-[#F2F0E9] text-2xl font-medium text-gray-700 active:bg-[#E5E2D9] active:scale-95 transition-all shadow-sm border border-black/5">{key}</button>))}
                        <button onClick={onDelete} className="h-14 rounded-[20px] bg-[#F2F0E9] flex items-center justify-center text-gray-500 active:bg-[#E5E2D9] active:scale-95 transition-all shadow-sm border border-black/5"><Delete size={24} /></button>
                        <button onClick={onSubmit} className="col-span-2 h-14 rounded-[20px] bg-[#1C1917] text-white text-lg font-bold active:scale-95 transition-all flex items-center justify-center gap-3 shadow-lg"><Check size={20} />Done</button>
                    </div>
                </div>
                </div>
            );
        };

        const AddTransaction = ({ isOpen, onClose, onSave, categories, onAddCategory, onDeleteCategory, currentMonthDate, themeColor }) => {
            const [amountStr, setAmountStr] = useState('');
            const [selectedType, setSelectedType] = useState(TransactionType.EXPENSE);
            const [selectedCategory, setSelectedCategory] = useState(null);
            const [customCategoryName, setCustomCategoryName] = useState('');
            const [note, setNote] = useState('');
            const [dateStr, setDateStr] = useState('');
            const [isKeyboardMinimized, setIsKeyboardMinimized] = useState(false);
            const [isCreatingCategory, setIsCreatingCategory] = useState(false);
            const [newCatName, setNewCatName] = useState('');
            const [newCatIcon, setNewCatIcon] = useState(AVAILABLE_ICONS[0]);
            const [editingCategoryId, setEditingCategoryId] = useState(null);
            const longPressTimerRef = useRef(null);
            const isLongPressRef = useRef(false);

            useEffect(() => {
                if (isOpen) {
                    setAmountStr(''); setNote(''); setIsCreatingCategory(false); setIsKeyboardMinimized(false); setNewCatName(''); setEditingCategoryId(null);
                    const now = new Date();
                    const isSameMonth = now.getFullYear() === currentMonthDate.getFullYear() && now.getMonth() === currentMonthDate.getMonth();
                    let initialDate = isSameMonth ? now : new Date(currentMonthDate.getFullYear(), currentMonthDate.getMonth(), 1, 12);
                    setDateStr(initialDate.toISOString().split('T')[0]);
                    const first = categories.find(c => c.type === selectedType);
                    if (first) { setSelectedCategory(first); setCustomCategoryName(first.name); } else { setSelectedCategory(null); setCustomCategoryName(''); }
                }
            }, [isOpen, selectedType, categories, currentMonthDate]);

            if (!isOpen) return null;

            const handleCategorySelect = (cat) => {
                if(editingCategoryId) { setEditingCategoryId(null); return; }
                setSelectedCategory(cat); setCustomCategoryName(cat.name); setIsKeyboardMinimized(true);
            };

            const handleKeyPress = (key) => { if (key === '.' && amountStr.includes('.')) return; setAmountStr(prev => prev + key); };
            const handleDeleteDigit = () => setAmountStr(prev => prev.slice(0, -1));
            const handleSubmit = () => {
                if (!selectedCategory) return alert("Please select a category");
                let finalAmount = 0; try { finalAmount = eval(amountStr.replace(/[^-()\d/*+.]/g, '')); } catch (e) { finalAmount = parseFloat(amountStr) || 0; }
                if (finalAmount <= 0) return;
                const [year, month, day] = dateStr.split('-').map(Number);
                const newTransaction = { id: Date.now().toString(), amount: Number(finalAmount.toFixed(2)), type: selectedType, categoryId: selectedCategory.id, categoryName: customCategoryName || selectedCategory.name, macroCategory: selectedCategory.macroCategory, note, date: new Date(year, month - 1, day).getTime() };
                onSave(newTransaction); onClose();
            };

            return (
                <div className="fixed inset-0 z-50 flex flex-col bg-[#F2F0E9] h-full font-sans overflow-hidden">
                <div className="flex justify-between items-center px-6 py-5 bg-[#F2F0E9] relative z-10">
                    {isCreatingCategory ? ( <button onClick={() => setIsCreatingCategory(false)} className="flex items-center text-gray-800 gap-2 font-bold hover:bg-black/5 p-2 rounded-xl"><ArrowLeft size={20} /><span className="text-sm">Back</span></button> ) : ( <button onClick={onClose} className="hover:bg-black/5 p-2 rounded-full"><X size={24} className="text-gray-800" /></button> )}
                    {!isCreatingCategory && (
                    <div className="flex bg-[#E5E2D9] rounded-2xl p-1.5">
                        {[TransactionType.EXPENSE, TransactionType.INCOME, TransactionType.TRANSFER].map(type => (
                        <button key={type} onClick={() => { setSelectedType(type); setSelectedCategory(null); setEditingCategoryId(null); setIsKeyboardMinimized(false); }} className={`px-5 py-2 rounded-xl text-sm font-bold transition-all ${selectedType === type ? 'bg-white text-black shadow-sm' : 'text-gray-500 hover:text-gray-700'}`}>{type === TransactionType.EXPENSE ? '支出' : type === TransactionType.INCOME ? '收入' : '转账'}</button>
                        ))}
                    </div>
                    )}
                    {isCreatingCategory && <div className="font-serif font-bold text-gray-800 text-lg">New Category</div>}
                    <div className="w-6"></div>
                </div>
                {isCreatingCategory ? (
                    <div className="flex-1 flex flex-col p-6 space-y-6 overflow-y-auto">
                    <div className="flex items-center gap-4 bg-[#FDFCF8] p-5 rounded-[24px] shadow-sm">
                        <div className="p-4 rounded-2xl" style={{ backgroundColor: hexToRgba(themeColor, 0.1), color: themeColor }}>{getIconComponent(newCatIcon, 28)}</div>
                        <input autoFocus type="text" value={newCatName} onChange={e => setNewCatName(e.target.value)} placeholder="Category Name" className="flex-1 text-xl font-serif font-bold outline-none text-gray-800 bg-transparent" />
                    </div>
                    <div>
                        <div className="text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-4">Select Icon</div>
                        <div className="grid grid-cols-6 gap-3">{AVAILABLE_ICONS.map(icon => (<button key={icon} onClick={() => setNewCatIcon(icon)} className={`aspect-square flex items-center justify-center rounded-2xl transition-all ${newCatIcon === icon ? 'text-white shadow-lg scale-105' : 'bg-white text-gray-400 hover:bg-[#E5E2D9]'}`} style={newCatIcon === icon ? { backgroundColor: themeColor } : {}}>{getIconComponent(icon, 20)}</button>))}</div>
                    </div>
                    <button onClick={() => { if(!newCatName.trim()) return; onAddCategory({ id: Date.now().toString(), name: newCatName.trim(), icon: newCatIcon, type: selectedType, macroCategory: selectedType === TransactionType.INCOME ? MacroCategory.INCOME : MacroCategory.NECESSARY }); setIsCreatingCategory(false); }} className="w-full py-4 text-white rounded-2xl font-bold text-lg mt-auto shadow-xl" style={{ backgroundColor: themeColor }}>Save Category</button>
                    </div>
                ) : (
                    <>
                    <div className="flex-1 overflow-y-auto p-6 no-scrollbar" onClick={() => setIsKeyboardMinimized(true)}>
                        <div className="grid grid-cols-4 gap-4 pb-20">
                        {categories.filter(c => c.type === selectedType).map(cat => (
                            <button key={cat.id} onClick={(e) => { e.stopPropagation(); handleCategorySelect(cat); }} className={`w-full flex flex-col items-center gap-2 p-3 rounded-[20px] transition-all relative ${selectedCategory?.id === cat.id ? 'bg-white ring-2 ring-offset-2 ring-offset-[#F2F0E9] shadow-md' : 'hover:bg-white/60'}`} style={selectedCategory?.id === cat.id ? { borderColor: themeColor, '--tw-ring-color': themeColor } : {}}>
                                <div className={`p-3.5 rounded-[16px] ${selectedCategory?.id === cat.id ? 'text-white' : 'bg-[#FDFCF8] text-gray-400'}`} style={selectedCategory?.id === cat.id ? { backgroundColor: themeColor } : {}}>{getIconComponent(cat.icon, 22)}</div>
                                <span className="text-[10px] text-center font-bold truncate w-full text-gray-800">{cat.name}</span>
                            </button>
                        ))}
                        <button onClick={() => setIsCreatingCategory(true)} className="flex flex-col items-center gap-2 p-3 rounded-[20px] hover:bg-white/60 transition-colors"><div className="p-3.5 rounded-[16px] text-gray-400 border-2 border-dashed border-gray-300"><Plus size={22} /></div><span className="text-[10px] text-center font-bold text-gray-400">Add</span></button>
                        </div>
                    </div>
                    <NumericKeypad onKeyPress={handleKeyPress} onDelete={handleDeleteDigit} onSubmit={handleSubmit} value={amountStr} isMinimized={isKeyboardMinimized} onToggle={() => setIsKeyboardMinimized(!isKeyboardMinimized)}>
                        <div className="bg-[#FDFCF8] rounded-[24px] p-2 shadow-sm space-y-2 border border-black/5">
                        {selectedCategory && ( <div className="flex items-center gap-3 bg-gray-50/50 px-3 py-2 rounded-xl border border-gray-100"><div style={{ color: themeColor }}>{getIconComponent(selectedCategory.icon, 16)}</div><input type="text" value={customCategoryName} onChange={(e) => setCustomCategoryName(e.target.value)} className="bg-transparent text-xs font-bold w-full outline-none text-gray-800" /></div> )}
                        <div className="flex gap-2">
                            <div className="flex-1 flex items-center gap-2 bg-gray-50/50 px-3 py-2 rounded-xl border border-gray-100"><Edit3 size={14} className="text-gray-400" /><input type="text" placeholder="Note..." value={note} onChange={(e) => setNote(e.target.value)} className="bg-transparent text-xs font-medium w-full outline-none" /></div>
                            <div className="relative flex items-center gap-2 bg-gray-50/50 px-3 py-2 rounded-xl border border-gray-100 min-w-[110px]"><Calendar size={14} className="text-gray-400" /><input type="date" required value={dateStr} onChange={(e) => setDateStr(e.target.value)} className="bg-transparent text-[10px] font-bold text-gray-700 outline-none w-full appearance-none" /></div>
                        </div>
                        </div>
                    </NumericKeypad>
                    </>
                )}
                </div>
            );
        };

        const SwipeableTransactionItem = ({ transaction: t, category, trendIcon, onDelete, isOpen, onSwipeOpen, onSwipeClose, isLast }) => {
            const icon = category ? category.icon : 'Wallet';
            const tDate = new Date(t.date);
            const formattedDate = `${tDate.getMonth() + 1}/${tDate.getDate()}`;
            const [dragOffset, setDragOffset] = useState(0);
            const touchStartX = useRef(null);
            useEffect(() => setDragOffset(0), [isOpen]);
            const handleTouchStart = (e) => { touchStartX.current = e.touches[0].clientX; };
            const handleTouchMove = (e) => {
                if (touchStartX.current === null) return;
                const diff = e.touches[0].clientX - touchStartX.current;
                if (!isOpen) { if (diff < 0 && diff > -80) setDragOffset(diff); } 
                else { if (diff > 0 && diff < 80) setDragOffset(diff); }
            };
            const handleTouchEnd = () => {
                if (touchStartX.current === null) return;
                if (!isOpen) { if (dragOffset < -40) onSwipeOpen(t.id); else setDragOffset(0); } 
                else { if (dragOffset > 40) onSwipeClose(); else setDragOffset(0); }
                touchStartX.current = null;
            };
            const visualOffset = (isOpen ? -80 : 0) + dragOffset;
            return (
                <div className="relative overflow-hidden w-full">
                <div className="absolute inset-y-0 right-0 w-[80px] bg-red-500 flex items-center justify-center text-white"><button onClick={() => onDelete(t.id)}><Trash2 size={24} /></button></div>
                <div className={`bg-[#FDFCF8] relative z-10 w-full transition-transform duration-300 ease-out border-b border-gray-50`} style={{ transform: `translateX(${visualOffset}px)` }} onTouchStart={handleTouchStart} onTouchMove={handleTouchMove} onTouchEnd={handleTouchEnd}>
                    <div className="p-4 flex items-center justify-between">
                    <div className="flex items-center gap-3">
                        <div className="w-10 h-10 rounded-[14px] flex items-center justify-center text-white shadow-sm" style={{ backgroundColor: getCategoryColor(t.categoryId) }}>{getIconComponent(icon, 18)}</div>
                        <div><div className="font-bold text-gray-800 text-sm flex items-center gap-1">{t.categoryName}{trendIcon}</div><div className="text-[10px] text-gray-400">{formattedDate} • {t.note || 'no note'}</div></div>
                    </div>
                    <div className={`font-serif font-bold ${t.type === 'INCOME' ? 'text-green-600' : 'text-gray-900'}`}>{t.type === 'INCOME' ? '+' : '-'}{t.amount.toFixed(2)}</div>
                    </div>
                </div>
                </div>
            );
        };

        const App = () => {
            const [transactions, setTransactions] = useState([]);
            const [categories, setCategoriesState] = useState([]);
            const [isAddModalOpen, setIsAddModalOpen] = useState(false);
            const [activeTab, setActiveTab] = useState('dashboard');
            const [themeColor, setThemeColor] = useState('#1C1917');
            const [selectedDate, setSelectedDate] = useState(new Date());
            const [openSwipeId, setOpenSwipeId] = useState(null);
            const [report, setReport] = useState(null);
            const [loadingReport, setLoadingReport] = useState(false);

            useEffect(() => {
                setTransactions(getTransactions());
                setCategoriesState(getCategories());
                const savedTheme = localStorage.getItem('wealthgrows_theme');
                if (savedTheme) setThemeColor(savedTheme);
            }, []);

            const dashboardStats = useMemo(() => calculateMonthlyStats(transactions, selectedDate), [transactions, selectedDate]);
            const prevDashboardStats = useMemo(() => getPreviousMonthStats(transactions, selectedDate), [transactions, selectedDate]);
            const displayTransactions = useMemo(() => transactions.filter(t => { const d = new Date(t.date); return d.getMonth() === selectedDate.getMonth() && d.getFullYear() === selectedDate.getFullYear(); }), [transactions, selectedDate]);
            const pieData = Object.entries(dashboardStats.categoryBreakdown).filter(([_, v]) => v > 0).map(([n, v]) => ({ name: n, value: v }));
            const getTrendIcon = (curr, prev) => { if (!prev || curr === prev) return null; const isInc = curr > prev; return <div className={`w-3 h-3 rounded-full flex items-center justify-center text-white ${isInc ? 'bg-red-500' : 'bg-green-500'}`}>{isInc ? <ArrowUpRight size={8} strokeWidth={4}/> : <ArrowDownRight size={8} strokeWidth={4}/>}</div>; };

            return (
                <div className="min-h-screen max-w-md mx-auto bg-[#F2F0E9] flex flex-col relative shadow-2xl overflow-hidden font-sans">
                <header className="px-8 pt-10 pb-4 flex justify-between items-center z-10 sticky top-0 bg-[#F2F0E9]/95 backdrop-blur-sm">
                    <div><h1 className="text-2xl font-serif font-bold" style={{ color: themeColor }}>这日子还过吗</h1><p className="text-[10px] text-gray-400 tracking-widest uppercase">Rational • FIRE</p></div>
                    <div className="relative"><div className="bg-white px-3 py-1.5 rounded-full shadow-sm text-xs font-bold font-serif">{selectedDate.getFullYear()}.{String(selectedDate.getMonth() + 1).padStart(2, '0')}</div><input type="month" className="absolute inset-0 opacity-0" onChange={e => e.target.value && setSelectedDate(new Date(e.target.value))} /></div>
                </header>
                <main className="flex-1 overflow-y-auto no-scrollbar pb-36 px-6">
                    <div className="flex p-1 gap-2 bg-gray-200/40 rounded-full mb-6 text-xs font-bold">
                        <button onClick={() => setActiveTab('dashboard')} className={`flex-1 py-2 rounded-full transition-all ${activeTab === 'dashboard' ? 'text-white shadow-sm' : 'text-gray-500'}`} style={activeTab === 'dashboard' ? { backgroundColor: themeColor } : {}}>概览</button>
                        <button onClick={() => setActiveTab('report')} className={`flex-1 py-2 rounded-full transition-all ${activeTab === 'report' ? 'text-white shadow-sm' : 'text-gray-500'}`} style={activeTab === 'report' ? { backgroundColor: themeColor } : {}}>AI诊断</button>
                    </div>
                    {activeTab === 'dashboard' ? (
                    <div className="space-y-6">
                        <div className="p-6 rounded-[28px] shadow-lg text-white relative overflow-hidden" style={{ backgroundColor: themeColor }}>
                            <div className="relative z-10 flex justify-between items-end">
                                <div><span className="text-[10px] font-bold opacity-70">NET SAVING</span><div className="text-3xl font-serif font-medium mt-1">{dashboardStats.savings.toFixed(2)}</div></div>
                                <div className="text-right"><div className="text-[10px] opacity-70">RATE</div><div className="font-serif text-lg">{(dashboardStats.savingsRate * 100).toFixed(0)}%</div></div>
                            </div>
                        </div>
                        <div className="grid grid-cols-2 gap-3">
                            <div className="bg-white p-4 rounded-2xl shadow-sm"><span className="text-[10px] text-gray-400 font-bold">INCOME</span><div className="text-xl font-serif text-gray-800 mt-1">{dashboardStats.totalIncome.toFixed(0)}</div></div>
                            <div className="bg-white p-4 rounded-2xl shadow-sm"><span className="text-[10px] text-gray-400 font-bold">EXPENSE</span><div className="text-xl font-serif text-gray-800 mt-1">{dashboardStats.totalExpense.toFixed(0)}</div></div>
                        </div>
                        <div className="bg-white rounded-[28px] overflow-hidden">
                            <div className="p-4 border-b border-gray-50 flex justify-between items-center"><h3 className="text-sm font-bold">近期明细</h3><ChevronDown size={14} className="text-gray-300"/></div>
                            {displayTransactions.map((t, idx) => (
                                <SwipeableTransactionItem key={t.id} transaction={t} category={categories.find(c => c.id === t.categoryId)} trendIcon={t.type === 'EXPENSE' ? getTrendIcon(dashboardStats.specificCategoryBreakdown[t.categoryId], prevDashboardStats.specificCategoryBreakdown[t.categoryId]) : null} onDelete={() => { deleteTransaction(t.id); setTransactions(getTransactions()); }} isOpen={openSwipeId === t.id} onSwipeOpen={setOpenSwipeId} onSwipeClose={() => setOpenSwipeId(null)} isLast={idx === displayTransactions.length - 1} />
                            ))}
                        </div>
                    </div>
                    ) : (
                    <div className="space-y-6">
                        <div className="bg-white p-6 rounded-[28px] shadow-sm space-y-4">
                            <h3 className="font-serif font-bold text-lg">开启AI深度财务分析</h3>
                            <button onClick={async () => { setLoadingReport(true); const r = await generateFinancialReport({ type: 'monthly', stats: dashboardStats, transactions: displayTransactions, dateLabel: '本月' }); setReport(r); setLoadingReport(false); }} className="w-full text-white font-bold py-3 rounded-xl shadow-md" style={{ backgroundColor: themeColor }}>{loadingReport ? '分析中...' : '生成诊断报告'}</button>
                        </div>
                        {report && <div className="bg-white p-6 rounded-[28px] shadow-sm markdown-body text-sm text-gray-700 whitespace-pre-wrap leading-relaxed">{report}</div>}
                    </div>
                    )}
                </main>
                <div className="fixed bottom-8 left-0 right-0 flex justify-center z-50 pointer-events-none">
                    <button onClick={() => setIsAddModalOpen(true)} className="pointer-events-auto text-white w-14 h-14 rounded-full shadow-2xl flex items-center justify-center hover:scale-110 active:scale-95 transition-transform" style={{ backgroundColor: themeColor }}><Plus size={32}/></button>
                </div>
                <AddTransaction isOpen={isAddModalOpen} onClose={() => setIsAddModalOpen(false)} onSave={(t) => { saveTransaction(t); setTransactions(getTransactions()); }} categories={categories} onAddCategory={(c) => setCategoriesState(addCategory(c))} onDeleteCategory={(id) => setCategoriesState(deleteCategory(id))} currentMonthDate={selectedDate} themeColor={themeColor} />
                </div>
            );
        };
        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>